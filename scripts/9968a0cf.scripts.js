"use strict";angular.module("depthyApp",["ngSanitize"]),angular.module("depthyApp").controller("MainCtrl",["$scope",function(a){var b=this;a.Modernizr=window.Modernizr,this.handleCompoundFile=function(c){var d=function(b){a.imageSource=!1,a.depthSource=!1,a.metadata={},a.compoundError=b};if("image/jpeg"!==c.type)return void d("Only JPEGs are supported!");var e=new FileReader;e.onload=function(c){a.compoundError="";try{var e=b.parseCompoundImage(c.target.result);a.imageSource=e.imageUri,a.depthSource=e.depthUri,delete e.imageData,delete e.depthData,delete e.imageUri,delete e.depthUri,a.metaData=e}catch(c){d(c)}a.$apply()},e.readAsBinaryString(c);var f=new FileReader;f.onload=function(b){console.log(b),a.compoundSource=b.target.result,a.$apply()},f.readAsDataURL(c)},this.parseCompoundImage=function(a){var b=(a.match(/xmpNote:HasExtendedXMP="(.+?)"/i)||[])[1];b&&(a=a.replace(new RegExp("[\\s\\S]{4}http:\\/\\/ns\\.adobe\\.com\\/xmp\\/extension\\/[\\s\\S]"+b+"[\\s\\S]{8}","g"),""));var c=a.match(/<x:xmpmeta [\s\S]+?<\/x:xmpmeta>/g),d={};if(!c)throw"No XMP metadata found! Did you make this photo using Google Camera?";if(c=c.join("\n",c),d.imageMime=(c.match(/GImage:Mime="(.+?)"/i)||[])[1],d.imageData=(c.match(/GImage:Data="(.+?)"/i)||[])[1],d.depthMime=(c.match(/GDepth:Mime="(.+?)"/i)||[])[1],d.depthData=(c.match(/GDepth:Data="(.+?)"/i)||[])[1],d.imageMime&&d.imageData&&(d.imageUri="data:"+d.imageMime+";base64,"+d.imageData),d.depthMime&&d.depthData&&(d.depthUri="data:"+d.depthMime+";base64,"+d.depthData),!d.depthUri)throw"No depth map found! Did you make this photo using Lens Blur mode?";return d.focalDistance=(c.match(/GFocus:FocalDistance="(.+?)"/i)||[])[1],d},a.$watch("compoundFiles",function(a){a&&a.length&&b.handleCompoundFile(a[0])})}]),angular.module("depthyApp").directive("fileselect",["$parse",function(a){return{restrict:"A",scope:!0,link:function(b,c,d){function e(c){b.$broadcast("fileselect",c),console.log(d.fileselect),d.fileselect&&a(d.fileselect).assign(b,c)}var f=document.createElement("input");f.type="file";var g=function(a){a.stopPropagation(),a.preventDefault()},h=function(a){a.stopPropagation(),a.preventDefault(),console.log(a);var c=a.originalEvent.dataTransfer;console.log(c);var d=c.files;console.log(d),e(d),b.$apply()};b.selectFile=function(a){f.click(),a&&a.preventDefault()},c.on("dragenter",g),c.on("dragover",g),c.on("drop",h),f.addEventListener("change",function(){e(this.files),b.$apply()},!1)}}}]),angular.module("depthyApp").directive("pixi",["$parse",function(a){return{template:"<canvas></canvas>",restrict:"A",link:function(b,c,d){function e(){h&&h(),requestAnimFrame(e),i.render(g)}var f=a(d.pixi),g=f(),h=b.$eval(d.pixiAnimate);g||(g=new PIXI.Stage(6750105),f.assign(b,g));var i=PIXI.autoDetectRenderer(400,300,c[0]);requestAnimFrame(e)}}}]),angular.module("depthyApp").controller("ViewerCtrl",["$scope",function(a){a.stage=null,a.$watch("stage",function(b){b&&a.$watch("imageSource",function(a){if(a){var c=PIXI.Texture.fromImage(a),d=new PIXI.Sprite(c);b.addChild(d)}})}),a.pixiAnimate=function(){}}]);